<!---
Copyright (c) 2010 The Chromium OS Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
--->

<html>
<script src='/urls.js'>

</script>
<script>

// Test normally takes 60 mins. Set time_ratio to 10 to
// speed up the test 10x. This reduces the amount of time
// spent on each task.
var time_ratio = 1;
var cycle_tabs = {};
var failed_loads = [0];
var successful_loads = [0];

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
  if (sender.tab.id in cycle_tabs) {
    successful_loads[0]++;
    if (request.action == "should_scroll") {
      sendResponse({"should_scroll": true,
                    "scroll_interval": cycle_tabs[sender.tab.id]});
    }
    delete cycle_tabs[sender.tab.id];
  }
});

function launch_task(task) {
  if (task.type == 'window' && task.tabs) {
    var url = task.tabs[0];
    chrome.windows.create({'url': url}, function (win) {
      for (var i = 1; i < task.tabs.length; i++) {
        chrome.tabs.create({'windowId': win.id, url: task.tabs[i]});
      }
      setTimeout(chrome.windows.remove, task.duration/time_ratio, win.id);
    })
  } else if (task.type == 'cycle' && task.urls) {
    var url = task.urls[0];
    var idx = 0;
    chrome.windows.create({'url': url}, function (win) {
      chrome.tabs.getSelected(win.id, function(tab) {
        cycle_tabs[tab.id] = task.scroll_interval;
        var cycleTask = setInterval(function(urls, tab_id) {
          if (tab_id in cycle_tabs && urls.length > 1) {
            failed_loads[0] += 1;
          }
          console.log('suc/fail: ' + successful_loads[0] + '/' + failed_loads[0]);
          cycle_tabs[tab_id] = task.scroll_interval;
          idx = (idx + 1) % urls.length;
          chrome.tabs.update(tab_id, {'url': urls[idx], 'selected': true})
        }, task.delay, task.urls, tab.id);
        setTimeout(function(win_id) {
          clearInterval(cycleTask);
          chrome.windows.remove(win_id);
        }, task.duration/time_ratio, win.id);
      });
    });
  }
}

function close_browser() {
  chrome.windows.getAll(null, function(windows) {
    for (var i = 0; i < windows.length; i++) {
      chrome.windows.remove(windows[i].id);
    }
  });
}


var end = 0;
var fuzz = 5000;
for (var i = 0; i < tasks.length; i++) {
  end = Math.max(end, (tasks[i].start+tasks[i].duration)/time_ratio)
  setTimeout(launch_task, tasks[i].start/time_ratio, tasks[i])
}
setTimeout(close_browser, end+fuzz)

</script>


<body>
</body>
</html>
