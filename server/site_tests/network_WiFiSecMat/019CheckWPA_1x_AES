# Copyright (c) 2010 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# Try 802.1x authentication.  The supplicant must be restarted between
# trials because it is "sticky" with regards to various parameters
# related to certificate authentication.  A thread is currently afoot
# in the hostap mailing list about this, but for the time being we will
# do supplicant restarts to test.

{ "name":"Check1x_AES",
  "steps":[             # Channel [any]
    [ "create",         { "type":"hostap" } ],
    [ "config",         { "channel":"2412", "mode":"11g",
                          "wpa":"1", "wpa_key_mgmt":"WPA-EAP",
                          "wpa_pairwise":"CCMP", "ieee8021x":"1",
                          "eap-tls":"cert1" } ],
    [ "connect",        { "security":"802_1x", "eap-tls":"cert1" } ],
    [ "client_ping",    { "count":"10" } ],
    [ "disconnect" ],

    [ "restart_supplicant" ],
    [ "config",         { "ssid_suffix":"t1" } ],
    [ "connect",        { "security":"802_1x", "eap-tls":"cert1",
                          "server-auth":"cert1" } ],
    [ "client_ping",    { "count":"10" } ],
    [ "disconnect" ],

    # Ensure authentication fails if server's cert doesn't match our CA cert
    [ "restart_supplicant" ],
    [ "config",         { "ssid_suffix":"t2" } ],
    [ "!connect",       { "security":"802_1x", "eap-tls":"cert1",
                          "server-auth":"cert2" },
                          "TLS: Certificate verification failed"],

    # Try authenticating using the wrong client certiificate
    [ "restart_supplicant" ],
    [ "config",         { "ssid_suffix":"t3" } ],
    [ "!connect",       { "security":"802_1x", "eap-tls":"cert2",
                          "server-auth":"cert1" },
                          "SSL: SSL3 alert: read "
                          "\(remote end reported an error\):fatal:unknown CA" ],
    [ "disconnect" ],

    [ "destroy" ],
  ],
}
