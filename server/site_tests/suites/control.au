# Copyright (c) 2010 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

AUTHOR = "Chrome OS Team"
NAME = "Auto Update Smoke Test"
TIME = "SHORT"
TEST_CATEGORY = "Functional"
TEST_CLASS = "suite"
TEST_TYPE = "server"

DOC = """
This is a special control file used by the autoupdate (AU) test scheduler. It
requires a target update URL be provided in order to run.

The test relies on Autotest to image the machine to the proper base image prior
to execution. The target machine is then imaged to the target version and a
basic smoke test is run to verify functionality.
"""

# Autoupdate test name.
AUTOUPDATE_TEST_NAME = 'autoupdate'

# suite_Smoke client control file.
CLIENT_CONTROL = 'client/site_tests/suite_Smoke/control'


def run_client_test(machine):
  client = hosts.create_host(machine)

  try:
    client.machine_install(force_update=True, update_url='%(update_url)s')
  except Exception, e:
    # Exceptions don't work in server job control files so record a failure for
    # the 'autoupdate' test with the exception message. Recording the failure in
    # this way allows us to easily generate emails for the failure later.
    job.record('FAIL', '', AUTOUPDATE_TEST_NAME, str(e))
    raise

  job.record('GOOD', '', AUTOUPDATE_TEST_NAME)

  # Execute client control file.
  autotest.Autotest(client).run(os.path.join(job.autodir, CLIENT_CONTROL))


job.parallel_on_machines(run_client_test, machines)
